//#include "../inc/espacc_config.h"
//#include "../inc/espacc.h"

#include "ad03_cxx_catapult.hpp"
#include "esp_headers.hpp" // ESP-common headers

#include <cstdlib>
#include <cstdio>

#include <mc_scverify.h>   // Enable SCVerify

//void softmax_tb(FPDATA_IN *input, double *output) {
//    double exp_in[PLM_SIZE];
//    double sum_exp = 0;
//    for (unsigned i = 0; i < PLM_SIZE; i++) {
//        exp_in[i] = exp(input[i].to_double());
//        sum_exp += exp_in[i];
//    }
//    for (unsigned i = 0; i < PLM_SIZE; i++) { output[i] = exp_in[i]/sum_exp; }
//}
//
double abs_double(const double &input)
{
    return input < 0 ? -input : input;
}

// This can be read from a file (and should)
static char raw_inputs[10][128] = {
{ -53, -2, -6, -4, -19, -17, -17, -22, -16, -19, -22, -27, -25, -25, -25, -31, -27, -37, -36, -35, -36, -34, -39, -37, -40, -40, -43, -43, -43, -42, -43, -38, -53, -4, -10, -1, -10, -17, -19, -18, -15, -26, -27, -24, -32, -25, -23, -36, -28, -35, -31, -37, -41, -42, -43, -35, -35, -37, -38, -39, -41, -41, -44, -35, -41, -2, -18, -13, -13, -9, -22, -21, -12, -24, -18, -23, -29, -26, -29, -37, -32, -28, -33, -34, -36, -38, -36, -40, -30, -37, -42, -43, -42, -38, -40, -38, -46, -2, -8, -15, -15, -13, -31, -29, -21, -27, -25, -27, -30, -29, -29, -32, -30, -39, -34, -34, -40, -40, -42, -38, -40, -41, -41, -42, -42, -42, -44, -38, },
{ -53, -4, -10, -1, -10, -17, -19, -18, -15, -26, -27, -24, -32, -25, -23, -36, -28, -35, -31, -37, -41, -42, -43, -35, -35, -37, -38, -39, -41, -41, -44, -35, -41, -2, -18, -13, -13, -9, -22, -21, -12, -24, -18, -23, -29, -26, -29, -37, -32, -28, -33, -34, -36, -38, -36, -40, -30, -37, -42, -43, -42, -38, -40, -38, -46, -2, -8, -15, -15, -13, -31, -29, -21, -27, -25, -27, -30, -29, -29, -32, -30, -39, -34, -34, -40, -40, -42, -38, -40, -41, -41, -42, -42, -42, -44, -38, -45, -3, -15, -5, -12, -16, -23, -22, -14, -25, -22, -27, -30, -28, -26, -32, -32, -38, -30, -39, -38, -36, -44, -39, -36, -36, -40, -44, -42, -43, -41, -37, },
{ -41, -2, -18, -13, -13, -9, -22, -21, -12, -24, -18, -23, -29, -26, -29, -37, -32, -28, -33, -34, -36, -38, -36, -40, -30, -37, -42, -43, -42, -38, -40, -38, -46, -2, -8, -15, -15, -13, -31, -29, -21, -27, -25, -27, -30, -29, -29, -32, -30, -39, -34, -34, -40, -40, -42, -38, -40, -41, -41, -42, -42, -42, -44, -38, -45, -3, -15, -5, -12, -16, -23, -22, -14, -25, -22, -27, -30, -28, -26, -32, -32, -38, -30, -39, -38, -36, -44, -39, -36, -36, -40, -44, -42, -43, -41, -37, -47, -8, -22, -8, -20, -9, -23, -25, -19, -23, -21, -23, -27, -25, -33, -32, -35, -34, -38, -35, -39, -40, -39, -39, -38, -38, -40, -40, -41, -44, -39, -38, },
{ -46, -2, -8, -15, -15, -13, -31, -29, -21, -27, -25, -27, -30, -29, -29, -32, -30, -39, -34, -34, -40, -40, -42, -38, -40, -41, -41, -42, -42, -42, -44, -38, -45, -3, -15, -5, -12, -16, -23, -22, -14, -25, -22, -27, -30, -28, -26, -32, -32, -38, -30, -39, -38, -36, -44, -39, -36, -36, -40, -44, -42, -43, -41, -37, -47, -8, -22, -8, -20, -9, -23, -25, -19, -23, -21, -23, -27, -25, -33, -32, -35, -34, -38, -35, -39, -40, -39, -39, -38, -38, -40, -40, -41, -44, -39, -38, -53, -8, -10, -17, -9, -18, -15, -23, -12, -21, -22, -34, -22, -23, -28, -30, -32, -37, -34, -36, -40, -40, -39, -38, -37, -39, -47, -45, -41, -41, -40, -38, },
{ -45, -3, -15, -5, -12, -16, -23, -22, -14, -25, -22, -27, -30, -28, -26, -32, -32, -38, -30, -39, -38, -36, -44, -39, -36, -36, -40, -44, -42, -43, -41, -37, -47, -8, -22, -8, -20, -9, -23, -25, -19, -23, -21, -23, -27, -25, -33, -32, -35, -34, -38, -35, -39, -40, -39, -39, -38, -38, -40, -40, -41, -44, -39, -38, -53, -8, -10, -17, -9, -18, -15, -23, -12, -21, -22, -34, -22, -23, -28, -30, -32, -37, -34, -36, -40, -40, -39, -38, -37, -39, -47, -45, -41, -41, -40, -38, -45, -3, -12, -9, -10, -17, -21, -20, -16, -22, -18, -21, -27, -29, -33, -33, -25, -32, -24, -30, -37, -35, -41, -40, -35, -37, -48, -38, -41, -42, -43, -40, },
{ -47, -8, -22, -8, -20, -9, -23, -25, -19, -23, -21, -23, -27, -25, -33, -32, -35, -34, -38, -35, -39, -40, -39, -39, -38, -38, -40, -40, -41, -44, -39, -38, -53, -8, -10, -17, -9, -18, -15, -23, -12, -21, -22, -34, -22, -23, -28, -30, -32, -37, -34, -36, -40, -40, -39, -38, -37, -39, -47, -45, -41, -41, -40, -38, -45, -3, -12, -9, -10, -17, -21, -20, -16, -22, -18, -21, -27, -29, -33, -33, -25, -32, -24, -30, -37, -35, -41, -40, -35, -37, -48, -38, -41, -42, -43, -40, -44, -5, -6, -5, -15, -15, -21, -17, -18, -21, -19, -33, -24, -28, -28, -33, -33, -35, -35, -40, -32, -40, -42, -38, -40, -39, -43, -37, -40, -42, -40, -38, },
{ -53, -8, -10, -17, -9, -18, -15, -23, -12, -21, -22, -34, -22, -23, -28, -30, -32, -37, -34, -36, -40, -40, -39, -38, -37, -39, -47, -45, -41, -41, -40, -38, -45, -3, -12, -9, -10, -17, -21, -20, -16, -22, -18, -21, -27, -29, -33, -33, -25, -32, -24, -30, -37, -35, -41, -40, -35, -37, -48, -38, -41, -42, -43, -40, -44, -5, -6, -5, -15, -15, -21, -17, -18, -21, -19, -33, -24, -28, -28, -33, -33, -35, -35, -40, -32, -40, -42, -38, -40, -39, -43, -37, -40, -42, -40, -38, -42, -7, -6, -13, -23, -15, -18, -15, -16, -21, -26, -24, -21, -26, -30, -32, -35, -37, -30, -31, -36, -39, -40, -38, -38, -37, -41, -38, -42, -41, -44, -39, },
{ -45, -3, -12, -9, -10, -17, -21, -20, -16, -22, -18, -21, -27, -29, -33, -33, -25, -32, -24, -30, -37, -35, -41, -40, -35, -37, -48, -38, -41, -42, -43, -40, -44, -5, -6, -5, -15, -15, -21, -17, -18, -21, -19, -33, -24, -28, -28, -33, -33, -35, -35, -40, -32, -40, -42, -38, -40, -39, -43, -37, -40, -42, -40, -38, -42, -7, -6, -13, -23, -15, -18, -15, -16, -21, -26, -24, -21, -26, -30, -32, -35, -37, -30, -31, -36, -39, -40, -38, -38, -37, -41, -38, -42, -41, -44, -39, -48, -17, -12, -5, -11, -7, -19, -25, -20, -11, -18, -25, -25, -27, -29, -36, -28, -31, -30, -32, -31, -38, -35, -42, -36, -41, -41, -40, -38, -43, -41, -40, },
{ -44, -5, -6, -5, -15, -15, -21, -17, -18, -21, -19, -33, -24, -28, -28, -33, -33, -35, -35, -40, -32, -40, -42, -38, -40, -39, -43, -37, -40, -42, -40, -38, -42, -7, -6, -13, -23, -15, -18, -15, -16, -21, -26, -24, -21, -26, -30, -32, -35, -37, -30, -31, -36, -39, -40, -38, -38, -37, -41, -38, -42, -41, -44, -39, -48, -17, -12, -5, -11, -7, -19, -25, -20, -11, -18, -25, -25, -27, -29, -36, -28, -31, -30, -32, -31, -38, -35, -42, -36, -41, -41, -40, -38, -43, -41, -40, -48, -7, -4, -4, -15, -15, -21, -16, -21, -10, -23, -26, -27, -23, -29, -33, -33, -32, -32, -35, -34, -40, -38, -40, -39, -39, -43, -38, -43, -44, -40, -38, },
{ -42, -7, -6, -13, -23, -15, -18, -15, -16, -21, -26, -24, -21, -26, -30, -32, -35, -37, -30, -31, -36, -39, -40, -38, -38, -37, -41, -38, -42, -41, -44, -39, -48, -17, -12, -5, -11, -7, -19, -25, -20, -11, -18, -25, -25, -27, -29, -36, -28, -31, -30, -32, -31, -38, -35, -42, -36, -41, -41, -40, -38, -43, -41, -40, -48, -7, -4, -4, -15, -15, -21, -16, -21, -10, -23, -26, -27, -23, -29, -33, -33, -32, -32, -35, -34, -40, -38, -40, -39, -39, -43, -38, -43, -44, -40, -38, -50, -7, -12, -8, -13, -17, -19, -24, -16, -18, -22, -27, -22, -27, -26, -26, -33, -35, -29, -34, -37, -37, -39, -41, -35, -38, -40, -37, -38, -43, -39, -40 }};

static char raw_outputs[10][128] = {
{ -44, -6, -7, -10, -14, -12, -18, -17, -15, -18, -19, -23, -23, -24, -25, -27, -27, -29, -28, -29, -30, -33, -33, -33, -33, -34, -34, -35, -37, -38, -38, -36, -44, -6, -8, -11, -15, -13, -17, -16, -16, -19, -19, -23, -23, -24, -25, -27, -28, -29, -29, -29, -32, -33, -33, -33, -33, -34, -35, -35, -37, -38, -38, -36, -44, -6, -7, -11, -14, -13, -17, -17, -16, -19, -20, -24, -23, -25, -27, -29, -28, -30, -30, -30, -31, -34, -34, -34, -34, -35, -35, -36, -38, -39, -38, -36, -45, -7, -8, -11, -14, -13, -17, -18, -16, -20, -19, -25, -24, -25, -27, -29, -29, -30, -30, -30, -32, -34, -34, -34, -34, -36, -36, -36, -38, -39, -39, -36 },
{ -42, -6, -8, -11, -14, -12, -18, -17, -16, -18, -18, -23, -24, -24, -25, -27, -27, -29, -28, -29, -30, -33, -33, -33, -33, -34, -34, -35, -37, -38, -38, -36, -42, -6, -9, -11, -15, -13, -17, -16, -16, -19, -19, -23, -24, -25, -26, -28, -28, -29, -29, -28, -32, -33, -33, -33, -33, -34, -35, -35, -37, -38, -39, -36, -42, -7, -8, -11, -15, -13, -17, -16, -16, -19, -20, -24, -24, -25, -27, -29, -29, -30, -29, -29, -31, -34, -34, -34, -34, -35, -35, -36, -39, -39, -38, -36, -43, -7, -9, -12, -15, -13, -18, -17, -16, -20, -19, -25, -25, -25, -27, -29, -29, -30, -30, -29, -31, -34, -34, -34, -34, -36, -36, -36, -38, -39, -39, -37 },
{ -40, -8, -10, -11, -15, -12, -17, -17, -16, -19, -19, -23, -24, -25, -25, -28, -28, -29, -28, -29, -31, -33, -33, -32, -32, -34, -34, -34, -36, -38, -37, -35, -40, -8, -11, -11, -15, -12, -17, -16, -16, -20, -19, -23, -24, -25, -25, -28, -28, -29, -29, -28, -32, -33, -33, -33, -32, -33, -34, -34, -36, -37, -37, -35, -40, -8, -10, -11, -15, -12, -17, -16, -16, -19, -19, -23, -23, -25, -26, -29, -28, -29, -29, -29, -31, -33, -33, -33, -33, -34, -34, -35, -37, -38, -37, -34, -40, -8, -11, -11, -15, -13, -17, -17, -16, -20, -19, -24, -24, -25, -25, -28, -28, -29, -29, -29, -31, -33, -33, -33, -33, -34, -35, -34, -36, -37, -37, -35 },
{ -43, -9, -11, -11, -16, -14, -19, -19, -17, -20, -20, -25, -26, -27, -27, -30, -29, -30, -30, -31, -32, -35, -36, -35, -34, -36, -36, -35, -37, -39, -39, -36, -43, -9, -11, -11, -16, -14, -18, -18, -17, -20, -20, -25, -25, -26, -27, -29, -29, -30, -30, -30, -33, -35, -35, -35, -34, -35, -36, -35, -37, -38, -39, -36, -43, -9, -10, -11, -15, -13, -17, -17, -16, -19, -20, -24, -24, -25, -26, -29, -28, -29, -29, -30, -31, -34, -34, -34, -34, -35, -36, -36, -38, -38, -38, -35, -43, -8, -10, -11, -15, -13, -17, -17, -16, -19, -19, -24, -24, -24, -25, -28, -27, -28, -28, -29, -30, -33, -34, -34, -33, -35, -36, -35, -37, -38, -38, -35 },
{ -44, -10, -11, -10, -15, -13, -17, -17, -16, -19, -18, -24, -24, -25, -26, -28, -28, -29, -29, -30, -31, -34, -35, -35, -34, -35, -36, -35, -37, -38, -38, -36, -44, -10, -12, -10, -15, -13, -16, -16, -15, -19, -18, -23, -23, -24, -25, -27, -28, -29, -29, -29, -32, -34, -34, -34, -33, -34, -36, -35, -37, -38, -38, -36, -44, -9, -11, -10, -15, -12, -15, -14, -15, -17, -18, -22, -22, -23, -24, -27, -26, -27, -28, -28, -30, -33, -33, -34, -33, -34, -35, -35, -37, -38, -37, -35, -44, -9, -10, -9, -14, -12, -15, -14, -14, -17, -17, -21, -21, -22, -23, -25, -25, -27, -27, -27, -29, -32, -33, -33, -32, -34, -35, -34, -36, -38, -38, -35 },
{ -44, -9, -11, -10, -15, -13, -17, -17, -16, -19, -18, -24, -24, -25, -26, -28, -28, -29, -29, -30, -31, -34, -35, -35, -34, -35, -36, -35, -37, -39, -38, -36, -44, -9, -11, -10, -15, -13, -16, -16, -16, -19, -18, -23, -23, -24, -25, -27, -27, -29, -29, -29, -32, -34, -34, -35, -33, -35, -36, -35, -37, -38, -38, -36, -44, -8, -10, -10, -14, -13, -15, -15, -15, -18, -18, -23, -22, -23, -24, -27, -27, -28, -28, -29, -30, -33, -34, -34, -33, -35, -36, -36, -38, -38, -38, -35, -44, -8, -10, -10, -14, -12, -15, -15, -14, -18, -17, -22, -22, -23, -24, -26, -26, -27, -28, -28, -30, -33, -33, -34, -32, -35, -35, -35, -37, -38, -38, -35 },
{ -43, -8, -8, -9, -14, -12, -17, -17, -15, -18, -18, -23, -23, -25, -25, -28, -28, -29, -29, -30, -31, -33, -35, -34, -34, -35, -35, -35, -37, -39, -38, -36, -44, -8, -8, -9, -14, -13, -16, -16, -14, -18, -18, -23, -23, -24, -25, -27, -28, -29, -29, -29, -32, -34, -34, -35, -33, -35, -36, -35, -38, -38, -38, -36, -44, -8, -8, -9, -14, -12, -15, -15, -14, -18, -19, -23, -22, -24, -25, -28, -27, -28, -29, -29, -31, -34, -34, -35, -34, -35, -36, -36, -38, -38, -38, -35, -44, -8, -8, -9, -13, -12, -15, -16, -14, -18, -18, -23, -22, -23, -24, -27, -27, -28, -28, -29, -30, -33, -34, -34, -33, -35, -36, -35, -37, -38, -38, -36 },
{ -41, -8, -9, -10, -14, -12, -17, -17, -16, -18, -18, -23, -23, -24, -24, -26, -27, -28, -28, -29, -30, -33, -34, -34, -33, -35, -35, -35, -37, -38, -38, -36, -41, -9, -9, -10, -14, -13, -16, -17, -16, -18, -18, -23, -23, -23, -24, -26, -27, -28, -28, -28, -32, -33, -34, -35, -33, -34, -36, -35, -37, -38, -38, -36, -42, -9, -8, -10, -14, -12, -16, -16, -15, -18, -18, -23, -22, -23, -24, -26, -26, -28, -28, -28, -30, -33, -34, -35, -33, -35, -36, -36, -38, -38, -37, -35, -42, -8, -9, -10, -13, -12, -16, -17, -15, -18, -18, -22, -22, -23, -24, -26, -26, -27, -27, -28, -30, -33, -34, -34, -33, -35, -36, -35, -37, -38, -38, -35 },
{ -42, -9, -8, -8, -13, -12, -16, -16, -14, -17, -18, -23, -23, -24, -24, -27, -27, -28, -28, -29, -31, -33, -34, -34, -33, -35, -35, -34, -36, -37, -37, -35, -42, -9, -8, -8, -13, -13, -15, -16, -14, -18, -17, -22, -22, -23, -24, -26, -27, -28, -28, -28, -31, -33, -33, -34, -33, -34, -35, -35, -37, -37, -37, -35, -42, -9, -8, -8, -13, -12, -14, -15, -13, -17, -17, -22, -21, -22, -23, -26, -26, -27, -28, -28, -30, -33, -33, -34, -33, -34, -35, -35, -37, -37, -37, -34, -42, -8, -8, -8, -12, -12, -14, -15, -13, -17, -17, -21, -21, -22, -22, -25, -25, -27, -27, -27, -29, -32, -33, -33, -32, -34, -35, -34, -36, -37, -37, -34 },
{ -44, -10, -9, -9, -13, -12, -16, -17, -15, -17, -17, -23, -22, -23, -24, -26, -26, -27, -28, -29, -30, -33, -34, -35, -33, -35, -35, -34, -36, -38, -37, -35, -44, -11, -9, -9, -13, -12, -16, -16, -15, -17, -17, -22, -22, -22, -23, -25, -26, -27, -28, -28, -31, -33, -34, -35, -32, -34, -36, -35, -36, -37, -38, -35, -44, -10, -8, -9, -13, -12, -15, -15, -15, -16, -17, -22, -21, -22, -23, -25, -25, -27, -28, -28, -30, -33, -33, -35, -33, -34, -35, -35, -37, -37, -37, -35, -44, -10, -9, -9, -13, -12, -15, -15, -14, -17, -17, -22, -21, -21, -23, -25, -25, -26, -27, -27, -29, -32, -33, -34, -32, -34, -35, -34, -36, -37, -37, -35 }};

#ifdef __CUSTOM_SIM__
int sc_main(int argc, char **argv) {
#else
CCS_MAIN(int argc, char **argv) {
#endif
    ESP_REPORT_INFO(VON, "--------------------------------");
    ESP_REPORT_INFO(VON, "ESP - AD03 [Catapult HLS C++]");
#ifdef HIERARCHICAL_BLOCKS
    ESP_REPORT_INFO(VON, "      Hierarchical blocks");
#else
    ESP_REPORT_INFO(VON, "      Single block");
#endif
    ESP_REPORT_INFO(VON, "--------------------------------");

    const unsigned ad03_size = PLM_SIZE;

    // Testbench return value (0 = PASS, non-0 = FAIL)
    int rc = 0;

    // Accelerator configuration
    ac_channel<conf_info_t> conf_info;

    conf_info_t conf_info_data;
    conf_info_data.batch = 1;
    conf_info_data.mode = 0;

    // Communication channels
    ac_channel<dma_info_t> dma_read_ctrl;
    ac_channel<dma_info_t> dma_write_ctrl;
    ac_channel<dma_data_t> dma_read_chnl;
    ac_channel<dma_data_t> dma_write_chnl;

    // Accelerator done (workaround)
    ac_sync acc_done;

    // Testbench data
    FPDATA_IN inputs[PLM_SIZE * BATCH_MAX];
    FPDATA_OUT outputs[PLM_SIZE * BATCH_MAX];
    FPDATA_OUT gold_outputs[PLM_SIZE * BATCH_MAX];

    ESP_REPORT_INFO(VON, "Configuration:");
    ESP_REPORT_INFO(VON, "  - batch: %u", ESP_TO_UINT32(conf_info_data.batch));
    ESP_REPORT_INFO(VON, "  - mode: %u", ESP_TO_UINT32(conf_info_data.mode));
    ESP_REPORT_INFO(VON, "Other info:");
    ESP_REPORT_INFO(VON, "  - DMA width: %u", DMA_WIDTH);
    ESP_REPORT_INFO(VON, "  - PLM size: %u", PLM_SIZE);
    ESP_REPORT_INFO(VON, "  - PLM width: %u", PLM_WIDTH);
    ESP_REPORT_INFO(VON, "  - AD03 in (words): %u", ad03_size);
    ESP_REPORT_INFO(VON, "  - AD03 out (words): %u", ad03_size);
    ESP_REPORT_INFO(VON, "  - total memory in (words): %u", ad03_size * ESP_TO_UINT32(conf_info_data.batch));
    ESP_REPORT_INFO(VON, "  - total memory out (words): %u", ad03_size * ESP_TO_UINT32(conf_info_data.batch));
    ESP_REPORT_INFO(VON, "-----------------");

#if 0
    for (unsigned i = 0; i < 8192; i++) {
        weight2_t w = 0.0;
        ac_int<DMA_WIDTH, false> w_ac;
        w_ac.set_slc(0, w.template slc<weight2_t::width>(0));
        dma_read_chnl.write(w_ac);
    }

    for (unsigned i = 0; i < 64; i++) {
        bias2_t b = 0.0;
        ac_int<DMA_WIDTH, false> b_ac;
        b_ac.set_slc(0, b.template slc<bias2_t::width>(0));
        dma_read_chnl.write(b_ac);
    }

    for (unsigned i = 0; i < 64; i++) {
        batch_normalization_scale_t bns = 0.0;
        ac_int<DMA_WIDTH, false> bns_ac;
        b_ac.set_slc(0, bns.template slc<batch_normalization_scale_t::width>(0));
        dma_read_chnl.write(bns_ac);
    }
#endif

    // DMA word
    // |<--- 0 --->|<--- 1 --->|<--- 2 --->|<--- 3 --->|
    //
    // Pass inputs to the accelerator
    for (unsigned i = 0; i < conf_info_data.batch; i++) {
        for (unsigned j = 0; j < ad03_size; j+=4) {
            FPDATA_IN data_fp_0 = raw_inputs[i][j+0];
            FPDATA_IN data_fp_1 = raw_inputs[i][j+1];
            FPDATA_IN data_fp_2 = raw_inputs[i][j+2];
            FPDATA_IN data_fp_3 = raw_inputs[i][j+3];

            inputs[i * ad03_size + j+0] = data_fp_3;
            inputs[i * ad03_size + j+1] = data_fp_2;
            inputs[i * ad03_size + j+2] = data_fp_1;
            inputs[i * ad03_size + j+3] = data_fp_0;

            ac_int<DMA_WIDTH, false> data_ac;
            data_ac.set_slc(WL*0, inputs[i * ad03_size + j+0].template slc<WL>(0));
            data_ac.set_slc(WL*1, inputs[i * ad03_size + j+1].template slc<WL>(0));
            data_ac.set_slc(WL*2, inputs[i * ad03_size + j+2].template slc<WL>(0));
            data_ac.set_slc(WL*3, inputs[i * ad03_size + j+3].template slc<WL>(0));

            dma_read_chnl.write(data_ac);
        }
    }
    // Pass configuration to the accelerator
    conf_info.write(conf_info_data);

    // Run the accelerator
#ifdef __CUSTOM_SIM__
    ad03_cxx_catapult(conf_info, dma_read_ctrl, dma_write_ctrl, dma_read_chnl, dma_write_chnl, acc_done);
#else
    CCS_DESIGN(ad03_cxx_catapult)(conf_info, dma_read_ctrl, dma_write_ctrl, dma_read_chnl, dma_write_chnl, acc_done);
#endif

    // Fetch outputs from the accelerator
    while (!dma_write_chnl.available(conf_info_data.batch * (ad03_size/4))) {} // Testbench stalls until data ready
    for (unsigned i = 0; i < conf_info_data.batch * ad03_size; i+=4) {
        ac_int<DMA_WIDTH, false> data = dma_write_chnl.read().template slc<DMA_WIDTH>(0);
        ac_int<WL, false> data_0 = data.template slc<DMA_WIDTH>(WL*0);
        ac_int<WL, false> data_1 = data.template slc<DMA_WIDTH>(WL*1);
        ac_int<WL, false> data_2 = data.template slc<DMA_WIDTH>(WL*2);
        ac_int<WL, false> data_3 = data.template slc<DMA_WIDTH>(WL*3);
        outputs[i+3].template set_slc<WL>(0, data_0);
        outputs[i+2].template set_slc<WL>(0, data_1);
        outputs[i+1].template set_slc<WL>(0, data_2);
        outputs[i+0].template set_slc<WL>(0, data_3);
    }

    // Validation
    unsigned errors = 0;
    ESP_REPORT_INFO(VON, "-----------------");
    for (unsigned i = 0; i < conf_info_data.batch; i++) {
        for (unsigned j = 0; j < ad03_size; j++) {
            gold_outputs[i * ad03_size + j] = raw_outputs[i][j];
        }
    }

    double allowed_error = 0.001;

    for (unsigned i = 0; i < conf_info_data.batch * ad03_size; i++) {
        FPDATA_OUT gold = gold_outputs[i];
        FPDATA_OUT data = outputs[i];

        // Calculate absolute error
        double error_it = abs_double(data.to_double() - gold.to_double());

        if (error_it > allowed_error) {
            ESP_REPORT_INFO(VON, "[%u]: %d (expected %d)", i, (char)data.to_int(), (char)gold.to_int());
            errors++;
        }
    }

    if (errors > 0) {
        ESP_REPORT_INFO(VON, "Validation: FAIL (errors %u / total %u)", errors, PLM_SIZE);
        rc = 1;
    } else {
        ESP_REPORT_INFO(VON, "Validation: PASS");
        rc = 0;
    }
    ESP_REPORT_INFO(VON, "  - errors %u / total %u", errors, PLM_SIZE);
    ESP_REPORT_INFO(VON, "-----------------");

#ifdef __CUSTOM_SIM__
    return rc;
#else
    CCS_RETURN(rc);
#endif
}
